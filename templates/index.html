<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictAAI - Geli≈ümi≈ü Analiz Motoru</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #ffc107;
            --primary-dark: #ff9800;
            --secondary: #667eea;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #0a0e27;
            --dark-light: #1a1f3a;
            --dark-lighter: #2a2f4a;
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --border: rgba(255, 193, 7, 0.1);
            --glow: rgba(255, 193, 7, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background:
                radial-gradient(ellipse at 10% 20%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(255, 193, 7, 0.1) 0%, transparent 50%);
            animation: bgPulse 20s ease-in-out infinite;
        }

        @keyframes bgPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .main-wrapper {
            position: relative;
            z-index: 1;
        }

        .premium-header {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(26, 31, 58, 0.95));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
        }

        .status-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(26, 31, 58, 0.8);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pill.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border-color: var(--success);
            color: var(--success);
        }

        .logo-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 25px 30px;
        }

        .logo-orb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--secondary), var(--primary-dark));
            border: 3px solid var(--primary);
            box-shadow: 0 0 40px var(--glow);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .logo-text h1 {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--primary), #fff, var(--primary));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .logo-text p {
            font-size: 11px;
            letter-spacing: 4px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .control-panel {
            padding: 20px 30px;
            background: rgba(26, 31, 58, 0.5);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .premium-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 12px;
            color: var(--dark);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .premium-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.5);
        }

        .premium-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .premium-btn.secondary {
            background: rgba(42, 47, 74, 0.9);
            border: 2px solid rgba(255, 193, 7, 0.3);
            color: var(--primary);
            box-shadow: none;
        }

        .premium-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .premium-match-card {
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.95), rgba(42, 47, 74, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.4s ease;
            max-width: 100%;
            overflow: hidden;
        }

        .premium-match-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .match-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .match-header {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .prediction-panel {
                min-width: 100% !important;
            }
        }

        .team-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .match-teams {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            line-height: 1.3;
        }

        .vs-separator {
            color: var(--primary);
            font-weight: 900;
            margin: 0 8px;
        }

        .match-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .meta-badge {
            padding: 3px 8px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            color: var(--primary);
        }

        .prediction-panel {
            background: rgba(10, 14, 39, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            min-width: 250px;
        }

        .prediction-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .odds-row {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .odds-label {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 600;
            min-width: 70px;
        }

        .odds-values {
            display: flex;
            gap: 5px;
            flex: 1;
            justify-content: flex-end;
        }

        .odd-item {
            padding: 5px 10px;
            background: rgba(42, 47, 74, 0.8);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            min-width: 45px;
            text-align: center;
        }

        .odd-item.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--dark);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
        }

        .confidence-meter {
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid;
            border-radius: 6px;
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .confidence-value {
            font-size: 14px;
            font-weight: 900;
        }

        .analysis-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .analysis-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
        }

        @media (max-width: 768px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        .analysis-card {
            background: rgba(10, 14, 39, 0.6);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
        }

        .analysis-card-title {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .analysis-card-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
        }

        .premium-loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 193, 7, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }

        .premium-alert {
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid;
        }

        .premium-alert.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            border-color: var(--success);
        }

        .premium-alert.warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));
            border-color: var(--primary);
        }

        .form-indicator {
            display: inline-flex;
            gap: 2px;
            padding: 3px 6px;
            background: rgba(10, 14, 39, 0.8);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }

        .form-w {
            color: var(--success);
        }

        .form-d {
            color: var(--primary);
        }

        .form-l {
            color: var(--danger);
        }

        .filter-panel {
            padding: 15px 20px;
            background: rgba(26, 31, 58, 0.5);
            border-bottom: 1px solid var(--border);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .filter-group select {
            padding: 8px 12px;
            background: rgba(42, 47, 74, 0.9);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            min-width: 130px;
        }

        .filter-group select:hover {
            border-color: var(--primary);
        }

        .compact-odds {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 6px;
        }

        .compact-odds-item {
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            font-size: 10px;
            font-weight: 600;
        }

        .data-quality {
            margin-top: 5px;
            padding: 4px;
            background: rgba(10, 14, 39, 0.6);
            border-radius: 4px;
            font-size: 8px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="animated-bg"></div>

    <div class="main-wrapper">
        <header class="premium-header">
            <div class="header-top">
                <div class="status-group">
                    <div class="status-pill active">
                        <span>üß† Akƒ±llƒ± Analiz Motoru</span>
                    </div>
                    <div class="status-pill">
                        üìä <span id="match-count">0</span> Ma√ß
                    </div>
                    <div class="status-pill">
                        üéØ <span id="prediction-count">0</span> Tahmin
                    </div>
                    <div class="status-pill" id="csv-status">
                        üìÇ CSV: Bekleniyor
                    </div>
                    <div class="status-pill" id="api-status">
                        üåê API: Kontrol Ediliyor
                    </div>
                </div>
            </div>

            <div class="logo-section">
                <div class="logo-orb"></div>
                <div class="logo-text">
                    <h1>PREDICTAAI</h1>
                    <p>Advanced AI Engine</p>
                </div>
            </div>

            <div class="control-panel">
                <button class="premium-btn secondary" onclick="manualLoadCSV()">
                    üìÇ Manuel CSV Y√ºkle
                </button>
                <button class="premium-btn" onclick="wakeUpAPI()" id="wake-api-btn">
                    üî• API'yi Uyandƒ±r
                </button>
                <button class="premium-btn" onclick="fetchMatches()" id="fetch-matches-btn">
                    üìä Ma√ßlarƒ± Y√ºkle
                </button>
                <button class="premium-btn" id="predict-all-btn" onclick="predictAllMatches()" disabled>
                    üéØ Geli≈ümi≈ü Analiz Yap
                </button>
                <button class="premium-btn secondary" onclick="loadManualMatches()">
                    üß™ Manuel Ma√ß Ekle
                </button>
                <button class="premium-btn secondary" onclick="clearAll()">
                    üóëÔ∏è Temizle
                </button>
            </div>

            <div class="filter-panel" id="filter-panel" style="display: none;">
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <div class="filter-group">
                        <label>üìÖ G√ºn:</label>
                        <select id="filter-date" onchange="applyFilters()">
                            <option value="all">T√ºm√º</option>
                            <option value="today">Bug√ºn</option>
                            <option value="tomorrow">Yarƒ±n</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>üéØ Min. G√ºven:</label>
                        <select id="filter-confidence" onchange="applyFilters()">
                            <option value="0">T√ºm√º</option>
                            <option value="50">%50+</option>
                            <option value="60">%60+</option>
                            <option value="70">%70+</option>
                            <option value="80">%80+</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>üìä Sƒ±ralama:</label>
                        <select id="filter-sort" onchange="applyFilters()">
                            <option value="default">Varsayƒ±lan</option>
                            <option value="confidence-desc">G√ºven (Y√ºksek ‚Üí D√º≈ü√ºk)</option>
                            <option value="confidence-asc">G√ºven (D√º≈ü√ºk ‚Üí Y√ºksek)</option>
                            <option value="date-asc">Tarih (Erken ‚Üí Ge√ß)</option>
                            <option value="quality-desc">Veri Kalitesi (Y√ºksek ‚Üí D√º≈ü√ºk)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>üîç Ma√ß Sonucu:</label>
                        <select id="filter-prediction" onchange="applyFilters()">
                            <option value="all">T√ºm√º</option>
                            <option value="1">Ev Sahibi (1)</option>
                            <option value="X">Beraberlik (X)</option>
                            <option value="2">Deplasman (2)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>üìà Alt/√úst 2.5:</label>
                        <select id="filter-overunder" onchange="applyFilters()">
                            <option value="all">T√ºm√º</option>
                            <option value="over">√úst 2.5</option>
                            <option value="under">Alt 2.5</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>üéØ KG Var/Yok:</label>
                        <select id="filter-btts" onchange="applyFilters()">
                            <option value="all">T√ºm√º</option>
                            <option value="yes">KG Var</option>
                            <option value="no">KG Yok</option>
                        </select>
                    </div>

                    <button class="premium-btn secondary" onclick="resetFilters()"
                        style="padding: 8px 16px; margin-left: auto;">
                        üîÑ Sƒ±fƒ±rla
                    </button>
                </div>
            </div>
        </header>

        <div class="premium-container" id="match-container">
            <div class="premium-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Hazƒ±rlanƒ±yor...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://predictaweb.onrender.com';

        let allMatches = [];
        let predictions = {};
        let historicalData = null;
        let teamStats = {};
        let teamNameIndex = {};
        let clubMappings = {};
        let apiStatus = 'checking';

        // 1. YENƒ∞: Levenshtein Mesafe Algoritmasƒ± (Harf hatasƒ± hesaplama)
        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // deƒüi≈ütirme
                            matrix[i][j - 1] + 1,     // ekleme
                            matrix[i - 1][j] + 1      // silme
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        // 2. G√úNCELLENMƒ∞≈û: ƒ∞ndeksleme Fonksiyonu
        function buildTeamNameIndex() {
            teamNameIndex = {};
            console.log('üîÑ Hƒ±zlƒ± arama indeksi olu≈üturuluyor...');
            const start = Date.now();

            Object.keys(teamStats).forEach(teamName => {
                const normalized = normalizeTeamName(teamName);
                // Normalize edilmi≈ü ismi asƒ±l isme e≈üle
                if (!teamNameIndex[normalized]) {
                    teamNameIndex[normalized] = teamName;
                }
                
                // Ayrƒ±ca varsa Club Mappings'i de indekse ekle
                if (clubMappings[normalized]) {
                    teamNameIndex[normalized] = clubMappings[normalized];
                }
            });
            
            console.log(`‚úÖ ƒ∞ndeksleme tamamlandƒ±: ${Object.keys(teamNameIndex).length} takƒ±m (${Date.now() - start}ms)`);
        }

        // 3. G√úNCELLENMƒ∞≈û: Hƒ±zlƒ± E≈üle≈ütirme Fonksiyonu
        function enhancedFindTeamStats(teamName) {
            if (!teamName || !teamStats) return null;
            
            // 1. Adƒ±m: Direkt E≈üle≈üme (En Hƒ±zlƒ±)
            if (teamStats[teamName]) return teamStats[teamName];
            
            // 2. Adƒ±m: ƒ∞ndeks √úzerinden E≈üle≈üme (√áok Hƒ±zlƒ±)
            const normalized = normalizeTeamName(teamName);
            if (teamNameIndex[normalized]) {
                const originalName = teamNameIndex[normalized];
                return teamStats[originalName];
            }

            // 3. Adƒ±m: Club Mappings Kontrol√º
            if (clubMappings[teamName]) return teamStats[clubMappings[teamName]];

            // 4. Adƒ±m: Levenshtein Fuzzy Match (Son √áare - ƒ∞yile≈ütirilmi≈ü)
            // Sadece benzer uzunluktaki takƒ±mlarƒ± kontrol et
            let bestMatch = null;
            let minDistance = 3; // En fazla 3 harf hatasƒ±na izin ver

            const candidates = Object.keys(teamNameIndex);
            
            for (const candidate of candidates) {
                // Optimizasyon: Uzunluk farkƒ± √ßoksa bakma
                if (Math.abs(candidate.length - normalized.length) > 3) continue;

                const dist = levenshteinDistance(normalized, candidate);
                
                if (dist < minDistance) {
                    minDistance = dist;
                    bestMatch = teamNameIndex[candidate];
                }
            }

            if (bestMatch) {
                console.log(`‚úÖ Fuzzy e≈üle≈üme: ${teamName} -> ${bestMatch} (Hata: ${minDistance})`);
                return teamStats[bestMatch];
            }
            
            // console.log(`‚ùå Bulunamadƒ±: ${teamName}`);
            return null;
        }

        // API Durum Kontrol√º
        async function checkAPIStatus() {
            try {
                const apiStatusElement = document.getElementById('api-status');
                const response = await fetchWithTimeout(`${API_BASE_URL}/health`, 5000);

                if (response.ok) {
                    apiStatus = 'online';
                    apiStatusElement.innerHTML = 'üåê API: <span style="color: var(--success)">√áalƒ±≈üƒ±yor</span>';
                    apiStatusElement.classList.add('active');
                    document.getElementById('fetch-matches-btn').disabled = false;
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                apiStatus = 'offline';
                document.getElementById('api-status').innerHTML = 'üåê API: <span style="color: var(--danger)">Kapalƒ±</span>';
                document.getElementById('fetch-matches-btn').disabled = true;
            }
        }

        function fetchWithTimeout(url, timeout = 10000) {
            return Promise.race([
                fetch(url),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout')), timeout)
                )
            ]);
        }

        // API Uyandƒ±rma
        async function wakeUpAPI() {
            const wakeBtn = document.getElementById('wake-api-btn');
            const originalText = wakeBtn.innerHTML;

            wakeBtn.innerHTML = '‚è≥ API Uyandƒ±rƒ±lƒ±yor...';
            wakeBtn.disabled = true;

            showLoading('API uyandƒ±rƒ±lƒ±yor...', 'Render sunucusu ba≈ülatƒ±lƒ±yor (30-60 sn s√ºrebilir)');

            let attempts = 0;
            const maxAttempts = 10;

            try {
                console.log('üîî API uyandƒ±rma isteƒüi g√∂nderiliyor...');
                const wakeResponse = await fetch(`${API_BASE_URL}/api/matches/upcoming?force_refresh=true`, {
                    method: 'GET',
                    mode: 'cors'
                }).catch(e => {
                    console.log('‚ö†Ô∏è ƒ∞lk uyandƒ±rma isteƒüi ba≈üarƒ±sƒ±z, normal...');
                });
            } catch (e) {
                console.log('‚ö†Ô∏è Uyandƒ±rma isteƒüi hata verdi, normal...');
            }

            const checkInterval = setInterval(async () => {
                attempts++;

                showLoading(
                    `API uyandƒ±rƒ±lƒ±yor... (${attempts}/${maxAttempts})`,
                    'Sunucu ba≈ülatƒ±lmasƒ± bekleniyor...'
                );

                try {
                    const healthResponse = await fetchWithTimeout(`${API_BASE_URL}/health`, 10000);

                    if (healthResponse.ok) {
                        clearInterval(checkInterval);
                        apiStatus = 'online';

                        document.getElementById('api-status').innerHTML = 'üåê API: <span style="color: var(--success)">√áalƒ±≈üƒ±yor</span>';
                        document.getElementById('api-status').classList.add('active');
                        document.getElementById('fetch-matches-btn').disabled = false;

                        wakeBtn.innerHTML = originalText;
                        wakeBtn.disabled = false;

                        showSuccess(`
                            ‚úÖ API ba≈üarƒ±yla uyandƒ±rƒ±ldƒ±!<br>
                            üéØ Artƒ±k ma√ßlarƒ± y√ºkleyebilirsiniz.<br>
                            ‚è±Ô∏è Toplam s√ºre: ${attempts * 5} saniye
                        `);

                        setTimeout(() => {
                            fetchMatches();
                        }, 2000);

                        return;
                    }
                } catch (error) {
                    console.log(`‚è≥ Deneme ${attempts}/${maxAttempts}: API hen√ºz hazƒ±r deƒüil`);
                }

                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);

                    wakeBtn.innerHTML = originalText;
                    wakeBtn.disabled = false;

                    showError(`
                        ‚ùå API uyandƒ±rƒ±lamadƒ±!<br><br>
                        <strong>Olasƒ± nedenler:</strong><br>
                        ‚Ä¢ Render sunucusu √ßok yava≈ü ba≈ülƒ±yor<br>
                        ‚Ä¢ API tamamen kapalƒ± olabilir<br>
                        ‚Ä¢ ƒ∞nternet baƒülantƒ± sorunu<br><br>
                        <strong>√á√∂z√ºmler:</strong><br>
                        ‚Ä¢ Birka√ß dakika sonra tekrar deneyin<br>
                        ‚Ä¢ Manuel ma√ß ekle butonunu kullanƒ±n<br>
                        ‚Ä¢ Render dashboard'dan API'yi kontrol edin
                    `);
                }
            }, 5000);
        }

        // Manuel CSV Y√ºkleme - G√úNCELLENDƒ∞: Yeni s√ºtun formatƒ±nƒ± destekler
        function manualLoadCSV() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';

            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const startTime = Date.now();
                showLoading('CSV dosyasƒ± okunuyor...', `Dosya: ${file.name}`);

                try {
                    const csvContent = await file.text();
                    const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);

                    console.log(`‚úÖ Dosya okundu! S√ºre: ${loadTime}s`);
                    showLoading(`CSV dosyasƒ± i≈üleniyor... (${loadTime}s'de okundu)`, 'Takƒ±m istatistikleri hesaplanƒ±yor...');

                    await parseAndLoadCSV(csvContent, 'Manuel');
                } catch (error) {
                    showError(`CSV y√ºklenemedi: ${error.message}`);
                }
            };

            fileInput.click();
        }

        // Tarihsel veri y√ºkleme - G√úNCELLENMƒ∞≈û
        async function loadHistoricalData() {
            const startTime = Date.now();
            const container = document.getElementById('match-container');

            container.innerHTML = `
                <div class="premium-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Birle≈ütirilmi≈ü veri seti y√ºkleniyor...</div>
                    <div style="color: var(--text-muted); margin-top: 10px; font-size: 14px;">
                        <span id="load-status">112,869 ma√ßlƒ±k veri seti hazƒ±rlanƒ±yor...</span>
                    </div>
                </div>
            `;

            try {
                // √ñnce takƒ±m e≈üle≈ütirmelerini y√ºkle
                try {
                    document.getElementById('load-status').textContent = 'Takƒ±m e≈üle≈ütirmeleri y√ºkleniyor...';
                    const clubsUrl = 'https://raw.githubusercontent.com/devcem09-cmd/predicta-api/main/data/all_clubs.csv';
                    const clubsResponse = await fetch(clubsUrl, {
                        mode: 'cors',
                        cache: 'no-cache'
                    });

                    if (clubsResponse.ok) {
                        const clubsContent = await clubsResponse.text();
                        parseClubMappings(clubsContent);
                        console.log(`‚úÖ ${Object.keys(clubMappings).length} takƒ±m e≈üle≈ütirmesi y√ºklendi`);
                        document.getElementById('load-status').textContent = `‚úÖ ${Object.keys(clubMappings).length} takƒ±m e≈üle≈ütirmesi y√ºklendi`;
                    }
                } catch (clubError) {
                    console.warn('‚ö†Ô∏è all_clubs.csv y√ºklenemedi:', clubError.message);
                    document.getElementById('load-status').textContent = '‚ö†Ô∏è Takƒ±m e≈üle≈ütirmeleri atlandƒ±';
                }

                // Bƒ∞RLE≈ûTƒ∞Rƒ∞LMƒ∞≈û VERƒ∞ SETƒ∞Nƒ∞ Y√úKLE
                document.getElementById('load-status').textContent = 'Birle≈ütirilmi≈ü veri seti y√ºkleniyor (112,869 ma√ß)...';
                const dataUrl = 'https://raw.githubusercontent.com/devcem09-cmd/predicta-api/main/data/final_unified_dataset.csv';

                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn('‚è±Ô∏è 20 saniye timeout!');
                }, 20000);

                console.log('üåê Birle≈ütirilmi≈ü veri y√ºkleniyor:', dataUrl);
                const response = await fetch(dataUrl, {
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'text/csv, text/plain, */*'
                    }
                });

                clearTimeout(timeoutId);

                console.log('üì° Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                document.getElementById('load-status').textContent = 'Birle≈ütirilmi≈ü veri i≈üleniyor...';
                const csvContent = await response.text();
                const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);

                console.log(`‚úÖ ${csvContent.length} karakter okundu (${loadTime}s)`);

                document.getElementById('load-status').textContent = 'Takƒ±m istatistikleri hesaplanƒ±yor...';
                await parseAndLoadUnifiedCSV(csvContent);

            } catch (error) {
                const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);

                console.error('‚ùå Birle≈ütirilmi≈ü veri y√ºkleme hatasƒ±:', error);

                // Fallback: Eski veri setini dene
                try {
                    showLoading('Birle≈ütirilmi≈ü veri y√ºklenemedi, eski veri deneniyor...');
                    await loadFallbackData();
                } catch (fallbackError) {
                    container.innerHTML = `
                        <div class="premium-alert warning">
                            ‚ùå Veri y√ºkleme ba≈üarƒ±sƒ±z (${loadTime}s)<br>
                            <strong>Hata:</strong> ${error.name} - ${error.message}<br><br>
                            
                            ${error.name === 'AbortError' ? `
                                <div style="background: rgba(255,193,7,0.1); padding: 10px; border-radius: 8px; margin: 10px 0;">
                                    ‚è±Ô∏è <strong>Zaman A≈üƒ±mƒ±:</strong> Dosya 20 saniyede y√ºklenemedi.
                                </div>
                            ` : ''}
                            
                            <strong>√á√∂z√ºm se√ßenekleri:</strong><br><br>
                            <button class="premium-btn" onclick="loadHistoricalData()" style="margin: 10px 5px;">
                                üîÑ Tekrar Dene
                            </button>
                            <button class="premium-btn secondary" onclick="manualLoadCSV()" style="margin: 10px 5px;">
                                üìÇ Manuel CSV Y√ºkle
                            </button>
                            <button class="premium-btn" onclick="skipCSVAndFetch()" style="margin: 10px 5px;">
                                ‚ö° CSV Olmadan Devam
                            </button>
                            <button class="premium-btn" onclick="loadManualMatches()" style="margin: 10px 5px;">
                                üß™ Manuel Ma√ß Ekle
                            </button>
                        </div>
                    `;
                }
            }
        }

        function parseClubMappings(csvContent) {
            clubMappings = {};
            const lines = csvContent.split('\n').filter(line => line.trim());

            console.log('üîç all_clubs.csv ilk satƒ±r:', lines[0]);

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split('|');

                if (parts.length >= 2) {
                    const firstPart = parts[0].trim();
                    const mainName = firstPart.substring(2).trim();

                    const aliases = parts.slice(1).map(p => {
                        return p.split('#')[0].trim();
                    }).filter(a => a.length > 0);

                    if (mainName) {
                        aliases.unshift(mainName);
                    }

                    aliases.forEach(alias => {
                        if (alias.length > 2) {
                            clubMappings[alias] = mainName;

                            const normalized = normalizeTeamName(alias);
                            if (normalized) {
                                clubMappings[normalized] = mainName;
                            }
                        }
                    });
                }
            }

            console.log(`üìã ${Object.keys(clubMappings).length} takƒ±m e≈üle≈ütirmesi hazƒ±r`);
        }

        // G√úNCELLENDƒ∞: Yeni CSV formatƒ±nƒ± destekleyen fonksiyon
        async function parseAndLoadCSV(csvContent, source = 'Dosya') {
            const parseStart = Date.now();

            try {
                const lines = csvContent.split('\n').filter(line => line.trim());
                const matches = [];

                // Ba≈ülƒ±k satƒ±rƒ±nƒ± oku ve s√ºtun e≈üle≈ütirmelerini yap
                const headers = lines[0].split(',').map(h => h.trim());
                
                // S√ºtun indekslerini bul
                const homeTeamIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('home') && h.toLowerCase().includes('team')
                );
                const awayTeamIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('away') && h.toLowerCase().includes('team')
                );
                const dateIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('date')
                );
                const scoreIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('score') || h.toLowerCase().includes('full time')
                );
                const resultIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('result')
                );
                const leagueIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('league') || h.toLowerCase().includes('division')
                );

                console.log('üìã CSV Ba≈ülƒ±klarƒ±:', headers);
                console.log('üîç S√ºtun indeksleri:', { homeTeamIndex, awayTeamIndex, dateIndex, scoreIndex, resultIndex, leagueIndex });

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    
                    // Skor bilgisini i≈üle (√∂rn: "3-2" -> home_score: 3, away_score: 2)
                    let home_score = 0;
                    let away_score = 0;
                    
                    if (scoreIndex !== -1 && values[scoreIndex]) {
                        const scoreParts = values[scoreIndex].split('-');
                        if (scoreParts.length === 2) {
                            home_score = parseInt(scoreParts[0]) || 0;
                            away_score = parseInt(scoreParts[1]) || 0;
                        }
                    }

                    const match = {
                        home_team: homeTeamIndex !== -1 ? values[homeTeamIndex] : null,
                        away_team: awayTeamIndex !== -1 ? values[awayTeamIndex] : null,
                        date: dateIndex !== -1 ? values[dateIndex] : null,
                        home_score: home_score,
                        away_score: away_score,
                        result: resultIndex !== -1 ? values[resultIndex] : null,
                        league: leagueIndex !== -1 ? values[leagueIndex] : null
                    };

                    // Ge√ßerli bir ma√ßsa ekle (en az takƒ±m isimleri olmalƒ±)
                    if (match.home_team && match.away_team && match.home_team.length > 1 && match.away_team.length > 1) {
                        matches.push(match);
                    }
                }

                historicalData = matches;

                if (historicalData.length === 0) {
                    throw new Error('CSV dosyasƒ±nda ge√ßerli veri bulunamadƒ±');
                }

                calculateTeamStats();
                buildTeamNameIndex();

                const parseTime = ((Date.now() - parseStart) / 1000).toFixed(1);

                document.getElementById('csv-status').innerHTML = `‚úÖ CSV: ${historicalData.length} ma√ß`;
                document.getElementById('csv-status').classList.add('active');

                console.log(`‚úÖ ƒ∞statistikler hesaplandƒ±! S√ºre: ${parseTime}s`);
                console.log(`üìä ${Object.keys(teamStats).length} takƒ±m analiz edildi`);

                // Hobro takƒ±mƒ±nƒ± test et
                const hobroStats = enhancedFindTeamStats('Hobro');
                console.log('Hobro istatistikleri:', hobroStats);

                showSuccess(`
                    ‚úÖ ${historicalData.length} ge√ßmi≈ü ma√ß y√ºklendi! (${source})<br>
                    üìä ${Object.keys(teamStats).length} takƒ±mƒ±n istatistikleri hazƒ±r!<br>
                    ‚ö° ƒ∞≈ülem s√ºresi: ${parseTime}s<br><br>
                    üéØ Artƒ±k "<strong>Ma√ßlarƒ± Y√ºkle</strong>" ile devam edebilirsiniz!
                `);

            } catch (error) {
                showError(`CSV i≈ülenemedi: ${error.message}`);
            }
        }

        // Takƒ±m istatistiklerini hesapla - EKSƒ∞K FONKSƒ∞YON TAMAMLANDI
        function calculateTeamStats() {
            teamStats = {};

            for (let i = 0; i < historicalData.length; i++) {
                const match = historicalData[i];

                if (!teamStats[match.home_team]) {
                    teamStats[match.home_team] = {
                        played: 0, wins: 0, draws: 0, losses: 0,
                        goalsFor: 0, goalsAgainst: 0,
                        homeGames: 0, homeWins: 0, homeDraws: 0, homeLosses: 0,
                        awayGames: 0, awayWins: 0, awayDraws: 0, awayLosses: 0,
                        homeGoalsFor: 0, homeGoalsAgainst: 0,
                        awayGoalsFor: 0, awayGoalsAgainst: 0,
                        recentForm: [],
                        h2h: {}
                    };
                }

                if (!teamStats[match.away_team]) {
                    teamStats[match.away_team] = {
                        played: 0, wins: 0, draws: 0, losses: 0,
                        goalsFor: 0, goalsAgainst: 0,
                        homeGames: 0, homeWins: 0, homeDraws: 0, homeLosses: 0,
                        awayGames: 0, awayWins: 0, awayDraws: 0, awayLosses: 0,
                        homeGoalsFor: 0, homeGoalsAgainst: 0,
                        awayGoalsFor: 0, awayGoalsAgainst: 0,
                        recentForm: [],
                        h2h: {}
                    };
                }

                const homeStats = teamStats[match.home_team];
                const awayStats = teamStats[match.away_team];

                homeStats.played++;
                homeStats.homeGames++;
                homeStats.goalsFor += match.home_score;
                homeStats.goalsAgainst += match.away_score;
                homeStats.homeGoalsFor += match.home_score;
                homeStats.homeGoalsAgainst += match.away_score;

                if (match.home_score > match.away_score) {
                    homeStats.wins++;
                    homeStats.homeWins++;
                    homeStats.recentForm.push('W');
                } else if (match.home_score === match.away_score) {
                    homeStats.draws++;
                    homeStats.homeDraws++;
                    homeStats.recentForm.push('D');
                } else {
                    homeStats.losses++;
                    homeStats.homeLosses++;
                    homeStats.recentForm.push('L');
                }

                awayStats.played++;
                awayStats.awayGames++;
                awayStats.goalsFor += match.away_score;
                awayStats.goalsAgainst += match.home_score;
                awayStats.awayGoalsFor += match.away_score;
                awayStats.awayGoalsAgainst += match.home_score;

                if (match.away_score > match.home_score) {
                    awayStats.wins++;
                    awayStats.awayWins++;
                    awayStats.recentForm.push('W');
                } else if (match.away_score === match.home_score) {
                    awayStats.draws++;
                    awayStats.awayDraws++;
                    awayStats.recentForm.push('D');
                } else {
                    awayStats.losses++;
                    awayStats.awayLosses++;
                    awayStats.recentForm.push('L');
                }

                if (!homeStats.h2h[match.away_team]) {
                    homeStats.h2h[match.away_team] = { wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0 };
                }
                if (!awayStats.h2h[match.home_team]) {
                    awayStats.h2h[match.home_team] = { wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0 };
                }

                if (match.home_score > match.away_score) {
                    homeStats.h2h[match.away_team].wins++;
                    awayStats.h2h[match.home_team].losses++;
                } else if (match.home_score === match.away_score) {
                    homeStats.h2h[match.away_team].draws++;
                    awayStats.h2h[match.home_team].draws++;
                } else {
                    homeStats.h2h[match.away_team].losses++;
                    awayStats.h2h[match.home_team].wins++;
                }

                homeStats.h2h[match.away_team].goalsFor += match.home_score;
                homeStats.h2h[match.away_team].goalsAgainst += match.away_score;
                awayStats.h2h[match.home_team].goalsFor += match.away_score;
                awayStats.h2h[match.home_team].goalsAgainst += match.home_score;
            }

            console.log(`‚úÖ ${Object.keys(teamStats).length} takƒ±mƒ±n istatistikleri hesaplandƒ±`);
        }

        function normalizeTeamName(name) {
            if (!name) return '';
            return name
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/[.-]/g, ' ')
                .replace(/'/g, '')
                .replace(/\b(fc|sk|sc|as|fk|bk|jk|tk|cf|cd|ud|ac|ca|ec|rc|club|atletico|sporting|real|deportivo)\b/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Geli≈ümi≈ü Oran √áekme Fonksiyonu - CANLI ORANLAR ƒ∞√áƒ∞N G√úNCELLENDƒ∞
        function extractOdds(match) {
            const odds = match.odds || {};

            console.log(`üìä ${match.home_team} vs ${match.away_team} - API'den gelen RAW odds:`, JSON.stringify(odds, null, 2));

            // Temel ma√ß sonucu oranlarƒ± (1X2)
            const baseOdds = {
                '1': odds['1'] || odds.home_win || odds.home || 2.0,
                'X': odds['X'] || odds.draw || 3.2,
                '2': odds['2'] || odds.away_win || odds.away || 3.5
            };

            // Alt/√úst 2.5 oranlarƒ±nƒ± √ßek - Farklƒ± formatlarda deneme
            let overUnderOdds = {
                'Over +2.5': 1.9,
                'Under +2.5': 1.9
            };

            // Format 1: "Over/Under +2.5" objesi
            if (odds['Over/Under +2.5']) {
                overUnderOdds = {
                    'Over +2.5': odds['Over/Under +2.5']['Over +2.5'] || 1.9,
                    'Under +2.5': odds['Over/Under +2.5']['Under +2.5'] || 1.9
                };
            }
            // Format 2: "over_under" objesi
            else if (odds.over_under) {
                overUnderOdds = {
                    'Over +2.5': odds.over_under.over || odds.over_under['over_2_5'] || 1.9,
                    'Under +2.5': odds.over_under.under || odds.over_under['under_2_5'] || 1.9
                };
            }
            // Format 3: Direkt "Over +2.5" anahtarlarƒ±
            else if (odds['Over +2.5']) {
                overUnderOdds = {
                    'Over +2.5': odds['Over +2.5'] || 1.9,
                    'Under +2.5': odds['Under +2.5'] || 1.9
                };
            }
            // Format 4: "over_2_5" formatƒ±
            else if (odds.over_2_5) {
                overUnderOdds = {
                    'Over +2.5': odds.over_2_5 || 1.9,
                    'Under +2.5': odds.under_2_5 || 1.9
                };
            }
            // Format 5: goals objesi i√ßinde
            else if (odds.goals) {
                overUnderOdds = {
                    'Over +2.5': odds.goals.over_2_5 || odds.goals.over || 1.9,
                    'Under +2.5': odds.goals.under_2_5 || odds.goals.under || 1.9
                };
            }

            // KG Var/Yok oranlarƒ±nƒ± √ßek - Farklƒ± formatlarda deneme
            let bttsOdds = {
                'Yes': 1.85,
                'No': 1.95
            };

            // Format 1: "Both Teams To Score" objesi
            if (odds['Both Teams To Score']) {
                bttsOdds = {
                    'Yes': odds['Both Teams To Score']['Yes'] || odds['Both Teams To Score']['yes'] || 1.85,
                    'No': odds['Both Teams To Score']['No'] || odds['Both Teams To Score']['no'] || 1.95
                };
            }
            // Format 2: "btts" objesi
            else if (odds.btts) {
                bttsOdds = {
                    'Yes': odds.btts.yes || odds.btts.Yes || 1.85,
                    'No': odds.btts.no || odds.btts.No || 1.95
                };
            }
            // Format 3: Direkt "BTTS Yes" anahtarlarƒ±
            else if (odds['BTTS Yes']) {
                bttsOdds = {
                    'Yes': odds['BTTS Yes'] || 1.85,
                    'No': odds['BTTS No'] || 1.95
                };
            }
            // Format 4: "both_teams_score" formatƒ±
            else if (odds.both_teams_score) {
                bttsOdds = {
                    'Yes': odds.both_teams_score.yes || 1.85,
                    'No': odds.both_teams_score.no || 1.95
                };
            }

            const finalOdds = {
                ...baseOdds,
                'Over/Under +2.5': overUnderOdds,
                'Both Teams To Score': bttsOdds
            };

            console.log(`‚úÖ ƒ∞≈ülenmi≈ü oranlar:`, finalOdds);

            return finalOdds;
        }

        function smartPredict(match) {
            const odds = extractOdds(match);

            if (!odds['1'] || !odds['X'] || !odds['2']) {
                return null;
            }

            const homeStats = enhancedFindTeamStats(match.home_team);
            const awayStats = enhancedFindTeamStats(match.away_team);

            console.log(`üîç Analiz: ${match.home_team} vs ${match.away_team}`);
            console.log(`üè† ${match.home_team} istatistikleri:`, homeStats ? 'Mevcut' : 'Yok');
            console.log(`‚úàÔ∏è ${match.away_team} istatistikleri:`, awayStats ? 'Mevcut' : 'Yok');

            const oddsAnalysis = analyzeOdds(odds);
            const formAnalysis = analyzeForm(match.home_team, match.away_team, homeStats, awayStats);
            const h2hAnalysis = analyzeH2H(match.home_team, match.away_team, homeStats, awayStats);
            const venueAnalysis = analyzeVenue(match.home_team, match.away_team, homeStats, awayStats);

            let scores = {
                '1': oddsAnalysis.homeWinProb * 0.40,
                'X': oddsAnalysis.drawProb * 0.40,
                '2': oddsAnalysis.awayWinProb * 0.40
            };

            if (formAnalysis.dataAvailable) {
                scores['1'] += formAnalysis.homeForm * 0.25;
                scores['2'] += formAnalysis.awayForm * 0.25;

                const formDiff = Math.abs(formAnalysis.homeForm - formAnalysis.awayForm);
                if (formDiff < 0.2) {
                    scores['X'] += 0.15;
                }
            }

            if (h2hAnalysis.dataAvailable) {
                if (h2hAnalysis.advantage === 'home') {
                    scores['1'] += 0.20;
                } else if (h2hAnalysis.advantage === 'away') {
                    scores['2'] += 0.20;
                } else if (h2hAnalysis.advantage === 'draw') {
                    scores['X'] += 0.15;
                }
            }

            if (venueAnalysis.dataAvailable) {
                if (venueAnalysis.homeAdvantage) {
                    scores['1'] += venueAnalysis.homeAdvantage * 0.15;
                }
                if (venueAnalysis.awayAdvantage) {
                    scores['2'] += venueAnalysis.awayAdvantage * 0.15;
                }
            }

            let prediction = '1';
            let maxScore = scores['1'];
            if (scores['X'] > maxScore) {
                prediction = 'X';
                maxScore = scores['X'];
            }
            if (scores['2'] > maxScore) {
                prediction = '2';
                maxScore = scores['2'];
            }

            const totalScore = scores['1'] + scores['X'] + scores['2'];
            let confidence = maxScore / totalScore;

            if (prediction === 'X') {
                confidence = Math.min(confidence * 0.85, 0.65);
            }

            const dataQuality = (
                (formAnalysis.dataAvailable ? 0.25 : 0) +
                (h2hAnalysis.dataAvailable ? 0.20 : 0) +
                (venueAnalysis.dataAvailable ? 0.15 : 0)
            ) / 0.60;

            confidence = confidence * (0.7 + (dataQuality * 0.3));

            const overUnder = predictOverUnder(odds, prediction, formAnalysis, venueAnalysis);
            const btts = predictBTTS(odds, oddsAnalysis, formAnalysis);

            return {
                prediction,
                confidence,
                dataQuality,
                analysis: {
                    odds: oddsAnalysis,
                    form: formAnalysis,
                    h2h: h2hAnalysis,
                    venue: venueAnalysis,
                    scores
                },
                over_under: overUnder,
                btts: btts
            };
        }

        function analyzeOdds(odds) {
            const home = parseFloat(odds['1']);
            const draw = parseFloat(odds['X']);
            const away = parseFloat(odds['2']);

            const homeProb = 1 / home;
            const drawProb = 1 / draw;
            const awayProb = 1 / away;

            const total = homeProb + drawProb + awayProb;

            const homeWinProb = homeProb / total;
            const drawProbNorm = drawProb / total;
            const awayWinProb = awayProb / total;

            let favorite = 'draw';
            if (home < draw && home < away) favorite = 'home';
            else if (away < draw && away < home) favorite = 'away';

            return {
                homeWinProb,
                drawProb: drawProbNorm,
                awayWinProb,
                favorite,
                homeOdds: home,
                drawOdds: draw,
                awayOdds: away
            };
        }

        function analyzeForm(homeTeam, awayTeam, homeStats = null, awayStats = null) {
            if (!homeStats || !awayStats) {
                homeStats = enhancedFindTeamStats(homeTeam);
                awayStats = enhancedFindTeamStats(awayTeam);
            }

            if (!homeStats || !awayStats) {
                return {
                    homeForm: null,
                    awayForm: null,
                    weight: 0.25,
                    dataAvailable: false
                };
            }

            const calculateFormScore = (form) => {
                const last5 = form.slice(-5);
                let score = 0;
                last5.forEach((result, index) => {
                    const weight = (index + 1) / 5;
                    if (result === 'W') score += 1 * weight;
                    else if (result === 'D') score += 0.5 * weight;
                });
                return last5.length > 0 ? score / last5.length : 0.5;
            };

            const homeFormScore = calculateFormScore(homeStats.recentForm);
            const awayFormScore = calculateFormScore(awayStats.recentForm);

            return {
                homeForm: homeFormScore,
                awayForm: awayFormScore,
                homeFormStr: homeStats.recentForm.slice(-5).join(''),
                awayFormStr: awayStats.recentForm.slice(-5).join(''),
                weight: 0.25,
                dataAvailable: true
            };
        }

        function analyzeH2H(homeTeam, awayTeam, homeStats = null, awayStats = null) {
            if (!homeStats || !awayStats) {
                homeStats = enhancedFindTeamStats(homeTeam);
                awayStats = enhancedFindTeamStats(awayTeam);
            }

            if (!homeStats || !awayStats) {
                return {
                    advantage: 'none',
                    weight: 0.20,
                    dataAvailable: false
                };
            }

            const homeH2H = homeStats.h2h[awayTeam] || homeStats.h2h[normalizeTeamName(awayTeam)];

            if (!homeH2H || (homeH2H.wins + homeH2H.draws + homeH2H.losses) === 0) {
                return {
                    advantage: 'none',
                    weight: 0.10,
                    dataAvailable: false,
                    totalGames: 0
                };
            }

            const totalGames = homeH2H.wins + homeH2H.draws + homeH2H.losses;
            const homeWinRate = homeH2H.wins / totalGames;
            const drawRate = homeH2H.draws / totalGames;

            let advantage = 'none';
            if (homeWinRate >= 0.5) advantage = 'home';
            else if (drawRate >= 0.4) advantage = 'draw';
            else advantage = 'away';

            return {
                advantage,
                homeWins: homeH2H.wins,
                draws: homeH2H.draws,
                awayWins: homeH2H.losses,
                totalGames,
                avgGoalsFor: (homeH2H.goalsFor / totalGames).toFixed(1),
                avgGoalsAgainst: (homeH2H.goalsAgainst / totalGames).toFixed(1),
                weight: 0.20
                ,
                dataAvailable: true
            };
        }

        function analyzeVenue(homeTeam, awayTeam, homeStats = null, awayStats = null) {
            if (!homeStats || !awayStats) {
                homeStats = enhancedFindTeamStats(homeTeam);
                awayStats = enhancedFindTeamStats(awayTeam);
            }

            if (!homeStats || !awayStats) {
                return {
                    homeAdvantage: 0,
                    awayAdvantage: 0,
                    dataAvailable: false
                };
            }

            const homeWinRate = homeStats.homeGames > 0 ?
                homeStats.homeWins / homeStats.homeGames : 0.5;

            const awayWinRate = awayStats.awayGames > 0 ?
                awayStats.awayWins / awayStats.awayGames : 0.3;

            const homeAvgGoalsFor = homeStats.homeGames > 0 ?
                homeStats.homeGoalsFor / homeStats.homeGames : 1.5;
            const awayAvgGoalsFor = awayStats.awayGames > 0 ?
                awayStats.awayGoalsFor / awayStats.awayGames : 1.0;

            return {
                homeAdvantage: homeWinRate,
                awayAdvantage: awayWinRate,
                homeAvgGoals: homeAvgGoalsFor.toFixed(2),
                awayAvgGoals: awayAvgGoalsFor.toFixed(2),
                homeWinRate: (homeWinRate * 100).toFixed(0),
                awayWinRate: (awayWinRate * 100).toFixed(0),
                dataAvailable: true
            };
        }

        function predictOverUnder(odds, matchPrediction, formAnalysis, venueAnalysis) {
            const overUnderOdds = odds['Over/Under +2.5'];
            const overOdds = parseFloat(overUnderOdds['Over +2.5']);
            const underOdds = parseFloat(overUnderOdds['Under +2.5']);

            let prediction = 'over';
            let confidence = 0.55;

            const minOdds = Math.min(overOdds, underOdds);
            if (minOdds < 1.70) {
                prediction = 'over';
                confidence = 0.62;
            } else if (overOdds > underOdds) {
                prediction = 'under';
                confidence = 0.60;
            } else if (overOdds >= 2.0 && overOdds <= 3.5 && underOdds >= 2.0 && underOdds <= 3.5) {
                prediction = 'over';
                confidence = 0.58;
            }

            if (venueAnalysis.homeAvgGoals && venueAnalysis.awayAvgGoals) {
                const totalAvgGoals = parseFloat(venueAnalysis.homeAvgGoals) +
                    parseFloat(venueAnalysis.awayAvgGoals);

                if (totalAvgGoals > 2.7) {
                    prediction = 'over';
                    confidence = Math.min(confidence + 0.08, 0.70);
                } else if (totalAvgGoals < 2.2) {
                    prediction = 'under';
                    confidence = Math.min(confidence + 0.06, 0.68);
                }
            }

            if (matchPrediction === '1' || matchPrediction === '2') {
                if (prediction === 'under') {
                    prediction = 'over';
                    confidence = Math.min(confidence + 0.05, 0.65);
                }
            }

            return { prediction, confidence };
        }

        function predictBTTS(odds, oddsAnalysis, formAnalysis) {
            const bttsOdds = odds['Both Teams To Score'];
            const yesOdds = parseFloat(bttsOdds['Yes']);
            const noOdds = parseFloat(bttsOdds['No']);

            let prediction = true;
            let confidence = 0.52;

            if (yesOdds < noOdds) {
                prediction = true;
                confidence = 0.58;
            } else if (oddsAnalysis.favorite !== 'draw') {
                const favoriteOdds = oddsAnalysis.favorite === 'home' ?
                    parseFloat(odds['1']) : parseFloat(odds['2']);

                if (favoriteOdds < 1.5) {
                    prediction = false;
                    confidence = 0.62;
                }
            }

            return { prediction, confidence };
        }

        async function fetchMatches() {
            if (apiStatus === 'offline') {
                showError('API kapalƒ±! L√ºtfen √∂nce "API\'yi Uyandƒ±r" butonuna tƒ±klayƒ±n.');
                return;
            }

            showLoading('Ma√ßlar y√ºkleniyor...');

            try {
                const response = await fetch(`${API_BASE_URL}/api/matches/upcoming?force_refresh=true`, {
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                if (data.success && Array.isArray(data.matches)) {
                    allMatches = data.matches;

                    if (allMatches.length > 0) {
                        console.log('üìä ƒ∞lk ma√ßƒ±n oran yapƒ±sƒ±:', allMatches[0].odds);
                    }

                    updateMatchCount();
                    displayMatches(allMatches);
                    document.getElementById('predict-all-btn').disabled = false;

                    showSuccess(`‚úÖ ${allMatches.length} ma√ß y√ºklendi!`);
                } else {
                    throw new Error('Ge√ßersiz veri');
                }
            } catch (error) {
                showError(`Ma√ßlar y√ºklenemedi: ${error.message}`);
                apiStatus = 'offline';
                document.getElementById('api-status').innerHTML = 'üåê API: <span style="color: var(--danger)">Kapalƒ±</span>';
                document.getElementById('fetch-matches-btn').disabled = true;
            }
        }

        function loadManualMatches() {
            allMatches = [
                {
                    match_id: 'manual1',
                    home_team: 'Hobro',
                    away_team: 'Hvidovre',
                    date: new Date(Date.now() + 86400000).toISOString(),
                    league_name: '1st Division',
                    league_code: 'DK1',
                    odds: {
                        '1': 2.7,
                        'X': 2.98,
                        '2': 1.97,
                        'Over/Under +2.5': { 'Over +2.5': 1.9, 'Under +2.5': 1.9 },
                        'Both Teams To Score': { 'Yes': 1.85, 'No': 1.95 }
                    }
                },
                {
                    match_id: 'manual2',
                    home_team: 'Galatasaray',
                    away_team: 'Fenerbah√ße',
                    date: new Date(Date.now() + 86400000).toISOString(),
                    league_name: 'S√ºper Lig',
                    league_code: 'TR1',
                    odds: {
                        '1': 2.10,
                        'X': 3.20,
                        '2': 3.50,
                        'Over/Under +2.5': { 'Over +2.5': 1.90, 'Under +2.5': 1.95 },
                        'Both Teams To Score': { 'Yes': 1.85, 'No': 1.95 }
                    }
                }
            ];

            updateMatchCount();
            displayMatches(allMatches);
            document.getElementById('predict-all-btn').disabled = false;
            document.getElementById('filter-panel').style.display = 'block';

            showSuccess(`‚úÖ ${allMatches.length} manuel ma√ß y√ºklendi! Analiz yapabilirsiniz.`);
        }

        async function predictAllMatches() {
            if (!historicalData) {
                showError('√ñnce CSV dosyasƒ±nƒ± y√ºkleyin!');
                return;
            }

            const predictBtn = document.getElementById('predict-all-btn');
            predictBtn.disabled = true;
            predictBtn.innerHTML = '‚è≥ Analiz Ediliyor...';

            showLoading('Geli≈ümi≈ü analiz yapƒ±lƒ±yor...', 'Oranlar, form, H2H ve ev/deplasman analizi');

            predictions = {};
            let successCount = 0;

            for (let i = 0; i < allMatches.length; i++) {
                const match = allMatches[i];

                const prediction = smartPredict(match);

                if (prediction) {
                    predictions[match.match_id] = prediction;
                    successCount++;
                }

                showLoading(
                    `Analiz ediliyor: ${i + 1}/${allMatches.length}`,
                    `‚úÖ ${successCount} ma√ß analiz edildi`
                );

                await new Promise(resolve => setTimeout(resolve, 50));
            }

            document.getElementById('filter-panel').style.display = 'block';

            displayMatches(allMatches);
            predictBtn.disabled = false;
            predictBtn.innerHTML = 'üéØ Geli≈ümi≈ü Analiz Yap';
            updatePredictionCount();

            showSuccess(`‚úÖ ${successCount} ma√ß i√ßin geli≈ümi≈ü tahmin √ºretildi!`);
        }

        function applyFilters() {
            const dateFilter = document.getElementById('filter-date').value;
            const confidenceFilter = parseInt(document.getElementById('filter-confidence').value);
            const sortFilter = document.getElementById('filter-sort').value;
            const predictionFilter = document.getElementById('filter-prediction').value;
            const overunderFilter = document.getElementById('filter-overunder').value;
            const bttsFilter = document.getElementById('filter-btts').value;

            let filteredMatches = [...allMatches];

            if (dateFilter !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                filteredMatches = filteredMatches.filter(match => {
                    const matchDate = new Date(match.date);
                    const matchDay = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate());

                    if (dateFilter === 'today') {
                        return matchDay.getTime() === today.getTime();
                    } else if (dateFilter === 'tomorrow') {
                        return matchDay.getTime() === tomorrow.getTime();
                    }
                    return true;
                });
            }

            if (confidenceFilter > 0) {
                filteredMatches = filteredMatches.filter(match => {
                    const pred = predictions[match.match_id];
                    return pred && (pred.confidence * 100) >= confidenceFilter;
                });
            }

            if (predictionFilter !== 'all') {
                filteredMatches = filteredMatches.filter(match => {
                    const pred = predictions[match.match_id];
                    return pred && pred.prediction === predictionFilter;
                });
            }

            if (overunderFilter !== 'all') {
                filteredMatches = filteredMatches.filter(match => {
                    const pred = predictions[match.match_id];
                    return pred && pred.over_under && pred.over_under.prediction === overunderFilter;
                });
            }

            if (bttsFilter !== 'all') {
                filteredMatches = filteredMatches.filter(match => {
                    const pred = predictions[match.match_id];
                    if (!pred || !pred.btts) return false;
                    if (bttsFilter === 'yes') return pred.btts.prediction === true;
                    if (bttsFilter === 'no') return pred.btts.prediction === false;
                    return true;
                });
            }

            if (sortFilter === 'confidence-desc') {
                filteredMatches.sort((a, b) => {
                    const predA = predictions[a.match_id];
                    const predB = predictions[b.match_id];
                    return (predB?.confidence || 0) - (predA?.confidence || 0);
                });
            } else if (sortFilter === 'confidence-asc') {
                filteredMatches.sort((a, b) => {
                    const predA = predictions[a.match_id];
                    const predB = predictions[b.match_id];
                    return (predA?.confidence || 0) - (predB?.confidence || 0);
                });
            } else if (sortFilter === 'date-asc') {
                filteredMatches.sort((a, b) => new Date(a.date) - new Date(b.date));
            } else if (sortFilter === 'quality-desc') {
                filteredMatches.sort((a, b) => {
                    const predA = predictions[a.match_id];
                    const predB = predictions[b.match_id];
                    return (predB?.dataQuality || 0) - (predA?.dataQuality || 0);
                });
            }

            displayMatches(filteredMatches);
        }

        function resetFilters() {
            document.getElementById('filter-date').value = 'all';
            document.getElementById('filter-confidence').value = '0';
            document.getElementById('filter-sort').value = 'default';
            document.getElementById('filter-prediction').value = 'all';
            document.getElementById('filter-overunder').value = 'all';
            document.getElementById('filter-btts').value = 'all';
            displayMatches(allMatches);
        }

        function displayMatches(matches) {
            const container = document.getElementById('match-container');

            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="premium-alert warning">
                        Hen√ºz ma√ß y√ºklenmedi. "Ma√ßlarƒ± Y√ºkle" butonuna tƒ±klayƒ±n.
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            matches.forEach(match => {
                const prediction = predictions[match.match_id];
                const card = createMatchCard(match, prediction);
                container.appendChild(card);
            });
        }

        function createMatchCard(match, prediction) {
            const card = document.createElement('div');
            card.className = 'premium-match-card';

            const hasPrediction = prediction && prediction.prediction;
            const confidence = hasPrediction ? (prediction.confidence * 100).toFixed(0) : 0;
            const pred = hasPrediction ? prediction.prediction : '?';

            if (hasPrediction) {
                if (confidence >= 70) {
                    card.style.borderLeftColor = 'var(--success)';
                    card.style.borderLeftWidth = '5px';
                } else if (confidence >= 60) {
                    card.style.borderLeftColor = 'var(--primary)';
                    card.style.borderLeftWidth = '4px';
                }
            }

            const overUnder = prediction?.over_under || {};
            const btts = prediction?.btts || {};
            const formAnalysis = prediction?.analysis?.form || {};
            const h2hAnalysis = prediction?.analysis?.h2h || {};
            const venueAnalysis = prediction?.analysis?.venue || {};

            const formatForm = (formStr) => {
                if (!formStr) return '<span style="color: var(--text-muted);">N/A</span>';
                return formStr.split('').map(c => {
                    if (c === 'W') return `<span class="form-w">W</span>`;
                    if (c === 'D') return `<span class="form-d">D</span>`;
                    if (c === 'L') return `<span class="form-l">L</span>`;
                    return c;
                }).join('');
            };

            // ‚úÖ Oranlarƒ± extractOdds ile √ßek (d√ºzg√ºn formatta geliyor)
            const odds = extractOdds(match);

            card.innerHTML = `
                <div class="match-header">
                    <div class="team-info">
                        <div class="match-teams">
                            ${match.home_team}<span class="vs-separator">VS</span>${match.away_team}
                        </div>
                        <div class="match-meta">
                            <span class="meta-badge">üèÜ ${match.league_name || match.league_code}</span>
                            <span class="meta-badge">üìÖ ${new Date(match.date).toLocaleDateString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            })}</span>
                            ${formAnalysis.homeFormStr ? `
                                <span class="meta-badge">
                                    üè† Form: <span class="form-indicator">${formatForm(formAnalysis.homeFormStr)}</span>
                                </span>
                            ` : ''}
                            ${formAnalysis.awayFormStr ? `
                                <span class="meta-badge">
                                    ‚úàÔ∏è Form: <span class="form-indicator">${formatForm(formAnalysis.awayFormStr)}</span>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="prediction-panel">
                        <div class="prediction-header">üìä TAHMƒ∞NLER & CANLI ORANLAR</div>
                        
                        <div class="odds-row">
                            <div class="odds-label">Ma√ß Sonucu:</div>
                            <div class="odds-values">
                                <div class="odd-item ${pred === '1' ? 'selected' : ''}">${odds['1']}</div>
                                <div class="odd-item ${pred === 'X' ? 'selected' : ''}">${odds['X']}</div>
                                <div class="odd-item ${pred === '2' ? 'selected' : ''}">${odds['2']}</div>
                            </div>
                        </div>
                        
                        <div class="odds-row">
                            <div class="odds-label">Alt/√úst 2.5:</div>
                            <div class="odds-values">
                                <div class="odd-item ${overUnder.prediction === 'over' ? 'selected' : ''}">${odds['Over/Under +2.5']['Over +2.5']}</div>
                                <div class="odd-item ${overUnder.prediction === 'under' ? 'selected' : ''}">${odds['Over/Under +2.5']['Under +2.5']}</div>
                            </div>
                        </div>
                        
                        <div class="odds-row">
                            <div class="odds-label">KG Var/Yok:</div>
                            <div class="odds-values">
                                <div class="odd-item ${btts.prediction === true ? 'selected' : ''}">${odds['Both Teams To Score']['Yes']}</div>
                                <div class="odd-item ${btts.prediction === false ? 'selected' : ''}">${odds['Both Teams To Score']['No']}</div>
                            </div>
                        </div>
                        
                        ${hasPrediction ? `
                            <div class="confidence-meter" style="border-color: ${confidence >= 70 ? 'var(--success)' : confidence >= 60 ? 'var(--primary)' : 'var(--secondary)'}">
                                <span style="font-size: 10px; color: var(--text-muted);">G√ºven</span>
                                <span class="confidence-value" style="color: ${confidence >= 70 ? 'var(--success)' : confidence >= 60 ? 'var(--primary)' : 'var(--secondary)'}">%${confidence}</span>
                            </div>
                            ${prediction.dataQuality !== undefined ? `
                            <div class="data-quality">
                                <span style="color: var(--text-muted);">Veri Kalitesi: </span>
                                <span style="color: ${prediction.dataQuality >= 0.8 ? 'var(--success)' : prediction.dataQuality >= 0.5 ? 'var(--primary)' : 'var(--danger)'}; font-weight: 700;">
                                    %${(prediction.dataQuality * 100).toFixed(0)}
                                </span>
                            </div>
                            ` : ''}
                        ` : '<div style="text-align: center; padding: 10px; color: var(--text-muted); font-size: 11px;">Analiz bekleniyor...</div>'}
                    </div>
                </div>
                
                ${hasPrediction ? `
                    <div class="analysis-section">
                        <div class="analysis-title">üìä Detaylƒ± Analiz</div>
                        <div class="analysis-grid">
                            ${h2hAnalysis.totalGames ? `
                            <div class="analysis-card">
                                <div class="analysis-card-title">ü§ù H2H (${h2hAnalysis.totalGames} ma√ß)</div>
                                <div style="margin-top: 5px; font-size: 9px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="color: var(--text-muted);">Ev:</span>
                                        <span style="color: var(--success); font-weight: 700;">${h2hAnalysis.homeWins}G</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="color: var(--text-muted);">Berabere:</span>
                                        <span style="color: var(--primary); font-weight: 700;">${h2hAnalysis.draws}B</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-muted);">Deplasman:</span>
                                        <span style="color: var(--danger); font-weight: 700;">${h2hAnalysis.awayWins}G</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${venueAnalysis.homeAvgGoals ? `
                            <div class="analysis-card">
                                <div class="analysis-card-title">üèüÔ∏è Ev/Deplasman</div>
                                <div style="margin-top: 5px; font-size: 9px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="color: var(--text-muted);">Ev Kazanma:</span>
                                        <span style="color: var(--primary); font-weight: 700;">${venueAnalysis.homeWinRate}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="color: var(--text-muted);">Deplasman:</span>
                                        <span style="color: var(--primary); font-weight: 700;">${venueAnalysis.awayWinRate}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-muted);">Ort. Gol:</span>
                                        <span style="color: var(--success); font-weight: 700;">${venueAnalysis.homeAvgGoals} - ${venueAnalysis.awayAvgGoals}</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="analysis-card">
                                <div class="analysis-card-title">üìà Alt/√úst 2.5</div>
                                <div style="display: flex; gap: 4px; margin-top: 5px;">
                                    <div style="flex: 1; padding: 6px 4px; background: ${overUnder.prediction === 'over' ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'rgba(42, 47, 74, 0.6)'}; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 9px; font-weight: 600; color: ${overUnder.prediction === 'over' ? 'var(--dark)' : 'var(--text-muted)'};">√úST</div>
                                        <div style="font-size: 10px; font-weight: 700; color: ${overUnder.prediction === 'over' ? 'var(--dark)' : 'var(--text-muted)'}; margin-top: 1px;">${odds['Over/Under +2.5']['Over +2.5']}</div>
                                    </div>
                                    <div style="flex: 1; padding: 6px 4px; background: ${overUnder.prediction === 'under' ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'rgba(42, 47, 74, 0.6)'}; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 9px; font-weight: 600; color: ${overUnder.prediction === 'under' ? 'var(--dark)' : 'var(--text-muted)'};">ALT</div>
                                        <div style="font-size: 10px; font-weight: 700; color: ${overUnder.prediction === 'under' ? 'var(--dark)' : 'var(--text-muted)'}; margin-top: 1px;">${odds['Over/Under +2.5']['Under +2.5']}</div>
                                    </div>
                                </div>
                                <div style="font-size: 8px; color: var(--success); text-align: center; margin-top: 3px;">G√ºven: %${(overUnder.confidence * 100).toFixed(0)}</div>
                            </div>
                            
                            <div class="analysis-card">
                                <div class="analysis-card-title">üéØ KG Var/Yok</div>
                                <div style="display: flex; gap: 4px; margin-top: 5px;">
                                    <div style="flex: 1; padding: 6px 4px; background: ${btts.prediction === true ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'rgba(42, 47, 74, 0.6)'}; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 9px; font-weight: 600; color: ${btts.prediction === true ? 'var(--dark)' : 'var(--text-muted)'};">VAR</div>
                                        <div style="font-size: 10px; font-weight: 700; color: ${btts.prediction === true ? 'var(--dark)' : 'var(--text-muted)'}; margin-top: 1px;">${odds['Both Teams To Score']['Yes']}</div>
                                    </div>
                                    <div style="flex: 1; padding: 6px 4px; background: ${btts.prediction === false ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'rgba(42, 47, 74, 0.6)'}; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 9px; font-weight: 600; color: ${btts.prediction === false ? 'var(--dark)' : 'var(--text-muted)'};">YOK</div>
                                        <div style="font-size: 10px; font-weight: 700; color: ${btts.prediction === false ? 'var(--dark)' : 'var(--text-muted)'}; margin-top: 1px;">${odds['Both Teams To Score']['No']}</div>
                                    </div>
                                </div>
                                <div style="font-size: 8px; color: var(--success); text-align: center; margin-top: 3px;">G√ºven: %${(btts.confidence * 100).toFixed(0)}</div>
                            </div>
                            
                            <div class="analysis-card">
                                <div class="analysis-card-title">üé≤ Olasƒ±lƒ±klar</div>
                                <div style="margin-top: 5px; font-size: 9px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="color: var(--text-muted);">Ev Sahibi:</span>
                                        <span style="color: var(--primary); font-weight: 700;">%${(prediction.analysis.scores['1'] / (prediction.analysis.scores['1'] + prediction.analysis.scores['X'] + prediction.analysis.scores['2']) * 100).toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="color: var(--text-muted);">Beraberlik:</span>
                                        <span style="color: var(--primary); font-weight: 700;">%${(prediction.analysis.scores['X'] / (prediction.analysis.scores['1'] + prediction.analysis.scores['X'] + prediction.analysis.scores['2']) * 100).toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-muted);">Deplasman:</span>
                                        <span style="color: var(--primary); font-weight: 700;">%${(prediction.analysis.scores['2'] / (prediction.analysis.scores['1'] + prediction.analysis.scores['X'] + prediction.analysis.scores['2']) * 100).toFixed(0)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                ` : ''}
            `;

            return card;
        }

        function clearAll() {
            allMatches = [];
            predictions = {};

            document.getElementById('match-container').innerHTML = `
                <div class="premium-alert warning">
                    Ma√ßlar temizlendi. "Ma√ßlarƒ± Y√ºkle" butonuna tƒ±klayƒ±n.
                </div>
            `;
            updateMatchCount();
            updatePredictionCount();
            document.getElementById('predict-all-btn').disabled = true;
        }

        function showLoading(message, subtext = '') {
            const container = document.getElementById('match-container');
            container.innerHTML = `
                <div class="premium-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">${message}</div>
                    ${subtext ? `<div style="color: var(--text-muted); margin-top: 10px; font-size: 14px;">${subtext}</div>` : ''}
                </div>
            `;
        }

        function showError(message) {
            const container = document.getElementById('match-container');
            container.innerHTML = `<div class="premium-alert" style="border-color: var(--danger); background: rgba(239, 68, 68, 0.2);">‚ùå ${message}</div>`;
        }

        function showSuccess(message) {
            const container = document.getElementById('match-container');
            const alert = document.createElement('div');
            alert.className = 'premium-alert success';
            alert.innerHTML = message;
            container.insertBefore(alert, container.firstChild);
            setTimeout(() => alert.remove(), 5000);
        }

        function updateMatchCount() {
            document.getElementById('match-count').textContent = allMatches.length;
        }

        function updatePredictionCount() {
            document.getElementById('prediction-count').textContent = Object.keys(predictions).length;
        }

        // Birle≈ütirilmi≈ü CSV'yi i≈üleme
        async function parseAndLoadUnifiedCSV(csvContent) {
            const parseStart = Date.now();

            try {
                const lines = csvContent.split('\n').filter(line => line.trim());
                const matches = [];

                // Ba≈ülƒ±k satƒ±rƒ±nƒ± oku
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                console.log('üìã Birle≈ütirilmi≈ü veri s√ºtunlarƒ±:', headers);

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= headers.length) {
                        const match = {};
                        headers.forEach((header, index) => {
                            match[header] = values[index]?.trim();
                        });

                        // Skor bilgisini i≈üle
                        if (match.home_score && match.away_score) {
                            match.home_score = parseInt(match.home_score) || 0;
                            match.away_score = parseInt(match.away_score) || 0;

                            // Sonu√ß bilgisini hesapla (eƒüer yoksa)
                            if (!match.result) {
                                if (match.home_score > match.away_score) {
                                    match.result = '1';
                                } else if (match.home_score < match.away_score) {
                                    match.result = '2';
                                } else {
                                    match.result = 'X';
                                }
                            }
                        }

                        // Ge√ßerli bir ma√ßsa ekle
                        if (match.home_team && match.away_team && match.home_team.length > 1 && match.away_team.length > 1) {
                            matches.push(match);
                        }
                    }
                }

                historicalData = matches;

                if (historicalData.length === 0) {
                    throw new Error('Birle≈ütirilmi≈ü CSV dosyasƒ±nda ge√ßerli veri bulunamadƒ±');
                }

                calculateTeamStatsFromUnified();
                buildTeamNameIndex();

                const parseTime = ((Date.now() - parseStart) / 1000).toFixed(1);

                document.getElementById('csv-status').innerHTML = `‚úÖ CSV: ${historicalData.length} ma√ß`;
                document.getElementById('csv-status').classList.add('active');

                console.log(`‚úÖ Birle≈ütirilmi≈ü istatistikler hesaplandƒ±! S√ºre: ${parseTime}s`);
                console.log(`üìä ${Object.keys(teamStats).length} takƒ±m analiz edildi`);

                showSuccess(`
                    ‚úÖ ${historicalData.length} birle≈ütirilmi≈ü ma√ß y√ºklendi!<br>
                    üìä ${Object.keys(teamStats).length} takƒ±mƒ±n istatistikleri hazƒ±r!<br>
                    ‚ö° ƒ∞≈ülem s√ºresi: ${parseTime}s<br><br>
                    üéØ Artƒ±k "<strong>Ma√ßlarƒ± Y√ºkle</strong>" ile devam edebilirsiniz!
                `);

            } catch (error) {
                showError(`Birle≈ütirilmi≈ü CSV i≈ülenemedi: ${error.message}`);
            }
        }

        // Birle≈ütirilmi≈ü veriden takƒ±m istatistikleri hesapla
        function calculateTeamStatsFromUnified() {
            teamStats = {};
            const totalMatches = historicalData.length;

            console.log(`üîÑ ${totalMatches} birle≈ütirilmi≈ü ma√ß i≈ülenecek...`);

            for (let i = 0; i < historicalData.length; i++) {
                const match = historicalData[i];
                const homeTeam = match.home_team;
                const awayTeam = match.away_team;
                const homeScore = parseInt(match.home_score) || 0;
                const awayScore = parseInt(match.away_score) || 0;

                if (!homeTeam || !awayTeam) continue;

                // Home team stats
                if (!teamStats[homeTeam]) {
                    teamStats[homeTeam] = {
                        played: 0, wins: 0, draws: 0, losses: 0,
                        goalsFor: 0, goalsAgainst: 0,
                        homeGames: 0, homeWins: 0, homeDraws: 0, homeLosses: 0,
                        awayGames: 0, awayWins: 0, awayDraws: 0, awayLosses: 0,
                        homeGoalsFor: 0, homeGoalsAgainst: 0,
                        awayGoalsFor: 0, awayGoalsAgainst: 0,
                        recentForm: [],
                        h2h: {}
                    };
                }

                // Away team stats  
                if (!teamStats[awayTeam]) {
                    teamStats[awayTeam] = {
                        played: 0, wins: 0, draws: 0, losses: 0,
                        goalsFor: 0, goalsAgainst: 0,
                        homeGames: 0, homeWins: 0, homeDraws: 0, homeLosses: 0,
                        awayGames: 0, awayWins: 0, awayDraws: 0, awayLosses: 0,
                        homeGoalsFor: 0, homeGoalsAgainst: 0,
                        awayGoalsFor: 0, awayGoalsAgainst: 0,
                        recentForm: [],
                        h2h: {}
                    };
                }

                const homeStats = teamStats[homeTeam];
                const awayStats = teamStats[awayTeam];

                // Home team g√ºncelle
                homeStats.played++;
                homeStats.homeGames++;
                homeStats.goalsFor += homeScore;
                homeStats.goalsAgainst += awayScore;
                homeStats.homeGoalsFor += homeScore;
                homeStats.homeGoalsAgainst += awayScore;

                if (homeScore > awayScore) {
                    homeStats.wins++;
                    homeStats.homeWins++;
                    homeStats.recentForm.push('W');
                } else if (homeScore === awayScore) {
                    homeStats.draws++;
                    homeStats.homeDraws++;
                    homeStats.recentForm.push('D');
                } else {
                    homeStats.losses++;
                    homeStats.homeLosses++;
                    homeStats.recentForm.push('L');
                }

                // Away team g√ºncelle
                awayStats.played++;
                awayStats.awayGames++;
                awayStats.goalsFor += awayScore;
                awayStats.goalsAgainst += homeScore;
                awayStats.awayGoalsFor += awayScore;
                awayStats.awayGoalsAgainst += homeScore;

                if (awayScore > homeScore) {
                    awayStats.wins++;
                    awayStats.awayWins++;
                    awayStats.recentForm.push('W');
                } else if (awayScore === homeScore) {
                    awayStats.draws++;
                    awayStats.awayDraws++;
                    awayStats.recentForm.push('D');
                } else {
                    awayStats.losses++;
                    awayStats.awayLosses++;
                    awayStats.recentForm.push('L');
                }

                // H2H istatistikleri
                if (!homeStats.h2h[awayTeam]) {
                    homeStats.h2h[awayTeam] = { wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0 };
                }
                if (!awayStats.h2h[homeTeam]) {
                    awayStats.h2h[homeTeam] = { wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0 };
                }

                if (homeScore > awayScore) {
                    homeStats.h2h[awayTeam].wins++;
                    awayStats.h2h[homeTeam].losses++;
                } else if (homeScore === awayScore) {
                    homeStats.h2h[awayTeam].draws++;
                    awayStats.h2h[homeTeam].draws++;
                } else {
                    homeStats.h2h[awayTeam].losses++;
                    awayStats.h2h[homeTeam].wins++;
                }

                homeStats.h2h[awayTeam].goalsFor += homeScore;
                homeStats.h2h[awayTeam].goalsAgainst += awayScore;
                awayStats.h2h[homeTeam].goalsFor += awayScore;
                awayStats.h2h[homeTeam].goalsAgainst += homeScore;
            }

            console.log(`‚úÖ ${Object.keys(teamStats).length} takƒ±mƒ±n istatistikleri birle≈ütirilmi≈ü veriden hesaplandƒ±`);
        }

        // Fallback veri y√ºkleme
        async function loadFallbackData() {
            console.log('üîÑ Fallback veri y√ºkleniyor...');
            const fallbackUrl = 'https://raw.githubusercontent.com/devcem09-cmd/predicta-api/main/data/merged_all.csv';

            const response = await fetch(fallbackUrl, {
                mode: 'cors',
                cache: 'no-cache'
            });

            if (!response.ok) {
                throw new Error('Fallback veri de y√ºklenemedi');
            }

            const csvContent = await response.text();
            await parseAndLoadCSV(csvContent, 'Fallback');
        }

        // CSV olmadan devam etme fonksiyonu
        function skipCSVAndFetch() {
            showSuccess('CSV olmadan devam ediliyor. Sadece oran bazlƒ± tahminler yapƒ±lacak.');
            historicalData = [];
            teamStats = {};
            document.getElementById('csv-status').innerHTML = 'üìÇ CSV: Atlandƒ±';
            document.getElementById('csv-status').style.opacity = '0.5';
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('match-container');
            container.innerHTML = `
                <div class="premium-alert success">
                    ‚úÖ PredictAAI Geli≈ümi≈ü Analiz Motoru Hazƒ±r!<br><br>
                    <strong>üß† √áalƒ±≈üma Prensibi:</strong><br>
                    1Ô∏è‚É£ <strong>Oran Analizi (%40)</strong> - Bahis oranlarƒ±ndan olasƒ±lƒ±k hesaplama<br>
                    2Ô∏è‚É£ <strong>Form Analizi (%25)</strong> - Son 5 ma√ßƒ±n aƒüƒ±rlƒ±klƒ± deƒüerlendirmesi<br>
                    3Ô∏è‚É£ <strong>H2H Analizi (%20)</strong> - Ge√ßmi≈ü kar≈üƒ±la≈ümalar<br>
                    4Ô∏è‚É£ <strong>Ev/Deplasman (%15)</strong> - Saha avantajƒ± ve performans<br><br>
                    <strong>üìä Ek Tahminler:</strong><br>
                    ‚Ä¢ Alt/√úst 2.5 Gol (gol ortalamalarƒ± dahil)<br>
                    ‚Ä¢ Kar≈üƒ±lƒ±klƒ± Gol (BTTS)<br>
                    ‚Ä¢ Detaylƒ± olasƒ±lƒ±k daƒüƒ±lƒ±mƒ±<br><br>
                    <strong>üî¥ CANLI ORANLAR:</strong><br>
                    ‚Ä¢ Ma√ß Sonucu (1X2)<br>
                    ‚Ä¢ Alt/√úst 2.5<br>
                    ‚Ä¢ Kar≈üƒ±lƒ±klƒ± Gol (KG Var/Yok)<br><br>
                    <strong>üöÄ Ba≈ülatƒ±lƒ±yor...</strong>
                </div>
            `;

            await checkAPIStatus();

            setTimeout(() => {
                loadHistoricalData().catch(error => {
                    console.error('CSV y√ºkleme hatasƒ±:', error);
                    container.innerHTML = `
                        <div class="premium-alert warning">
                            ‚ö†Ô∏è Otomatik y√ºkleme ba≈üarƒ±sƒ±z oldu.<br><br>
                            <strong>√á√∂z√ºm se√ßenekleri:</strong><br><br>
                            <button class="premium-btn" onclick="loadHistoricalData()" style="margin: 10px 5px;">
                                üîÑ Tekrar Dene
                            </button>
                            <button class="premium-btn secondary" onclick="manualLoadCSV()" style="margin: 10px 5px;">
                                üìÇ Manuel CSV Y√ºkle
                            </button>
                            <button class="premium-btn" onclick="skipCSVAndFetch()" style="margin: 10px 5px;">
                                ‚ö° CSV Olmadan Devam
                            </button>
                            <button class="premium-btn" onclick="loadManualMatches()" style="margin: 10px 5px;">
                                üß™ Manuel Ma√ß Ekle
                            </button>
                        </div>
                    `;
                });
            }, 1000);
        });
    </script>
</body>

</html>
